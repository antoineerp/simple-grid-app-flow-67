
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostic FormaCert</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 { color: #2563eb; }
    h2 { color: #4b5563; margin-top: 30px; }
    .result { 
      font-family: monospace;
      background: #f1f5f9;
      padding: 15px;
      border-radius: 5px;
      white-space: pre-wrap;
      margin: 10px 0;
      max-height: 300px;
      overflow: auto;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover {
      background: #1d4ed8;
    }
  </style>
</head>
<body>
  <h1>Outil de diagnostic FormaCert</h1>
  <p>Cet outil vous aide à diagnostiquer les problèmes de chargement de l'application et de la console Lovable.</p>
  
  <h2>1. Test de connexion aux CDN</h2>
  <button onclick="testCdnConnections()">Tester les connexions CDN</button>
  <div id="cdn-results" class="result">Cliquez sur le bouton pour lancer le test...</div>
  
  <h2>2. Vérification des scripts</h2>
  <button onclick="checkScripts()">Vérifier les scripts</button>
  <div id="scripts-results" class="result">Cliquez sur le bouton pour lancer le test...</div>
  
  <h2>3. Test du script Lovable</h2>
  <button onclick="testLovableScript()">Tester le script Lovable</button>
  <div id="lovable-results" class="result">Cliquez sur le bouton pour lancer le test...</div>
  
  <h2>4. Informations sur le navigateur</h2>
  <button onclick="getBrowserInfo()">Obtenir les informations du navigateur</button>
  <div id="browser-results" class="result">Cliquez sur le bouton pour lancer le test...</div>
  
  <h2>5. Test de résolution DNS</h2>
  <button onclick="testDns()">Tester la résolution DNS</button>
  <div id="dns-results" class="result">Cliquez sur le bouton pour lancer le test...</div>
  
  <h2>Résultats du diagnostic</h2>
  <button onclick="runAllTests()">Exécuter tous les tests</button>
  <div id="all-results" class="result">Cliquez sur le bouton pour lancer tous les tests...</div>
  
  <script>
    // Test de connexion aux CDN
    function testCdnConnections() {
      const resultDiv = document.getElementById('cdn-results');
      resultDiv.innerHTML = "Test en cours...";
      
      const cdns = [
        { url: 'https://cdn.gpteng.co/ping', name: 'Lovable CDN' },
        { url: 'https://fonts.googleapis.com/favicon.ico', name: 'Google Fonts' },
        { url: 'https://www.gstatic.com/favicon.ico', name: 'Google Static' }
      ];
      
      let results = "";
      let completedTests = 0;
      
      cdns.forEach(cdn => {
        fetch(cdn.url, { 
          mode: 'no-cors', 
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache' }
        })
        .then(() => {
          results += `<span class="success">✓ Connexion réussie à ${cdn.name}</span>\n`;
          checkCompleted();
        })
        .catch(err => {
          results += `<span class="error">✗ Échec de connexion à ${cdn.name}: ${err.message}</span>\n`;
          checkCompleted();
        });
      });
      
      function checkCompleted() {
        completedTests++;
        if (completedTests === cdns.length) {
          resultDiv.innerHTML = results;
          
          // Ajouter un résumé
          if (!results.includes("Échec")) {
            resultDiv.innerHTML += `\n<span class="success">Tous les CDN sont accessibles.</span>`;
          } else {
            resultDiv.innerHTML += `\n<span class="warning">Certains CDN ne sont pas accessibles. Vérifiez votre connexion ou vos bloqueurs de contenu.</span>`;
          }
        }
      }
    }
    
    // Vérification des scripts
    function checkScripts() {
      const resultDiv = document.getElementById('scripts-results');
      resultDiv.innerHTML = "Vérification des scripts...";
      
      const scripts = document.querySelectorAll('script');
      let results = `Nombre de scripts trouvés: ${scripts.length}\n\n`;
      
      let hasLovableScript = false;
      let hasMainScript = false;
      
      scripts.forEach((script, index) => {
        const src = script.getAttribute('src') || '(inline script)';
        results += `${index + 1}. ${src}\n`;
        
        if (src.includes('gptengineer.js')) {
          hasLovableScript = true;
        }
        
        if (src.includes('main.tsx') || src.includes('main.js')) {
          hasMainScript = true;
        }
      });
      
      if (hasLovableScript) {
        results += `\n<span class="success">✓ Script Lovable trouvé</span>`;
      } else {
        results += `\n<span class="error">✗ Script Lovable NON trouvé</span>`;
      }
      
      if (hasMainScript) {
        results += `\n<span class="success">✓ Script principal trouvé</span>`;
      } else {
        results += `\n<span class="warning">⚠ Script principal non détecté</span>`;
      }
      
      resultDiv.innerHTML = results;
    }
    
    // Test du script Lovable
    function testLovableScript() {
      const resultDiv = document.getElementById('lovable-results');
      resultDiv.innerHTML = "Test en cours...";
      
      let results = "";
      
      // Vérifier si la variable __LOVABLE_EDITOR__ est définie
      if (typeof window.__LOVABLE_EDITOR__ !== 'undefined') {
        results += `<span class="success">✓ Variable __LOVABLE_EDITOR__ détectée</span>\n`;
        results += `<span class="success">✓ Console Lovable chargée correctement</span>`;
      } else {
        results += `<span class="error">✗ Variable __LOVABLE_EDITOR__ non détectée</span>\n`;
        
        // Vérifier si le script est présent
        const lovableScript = document.querySelector('script[src*="gptengineer.js"]');
        if (lovableScript) {
          results += `<span class="warning">⚠ Script Lovable présent mais non initialisé</span>\n`;
          results += `<span class="warning">Causes possibles:</span>\n`;
          results += `- Blocage par un pare-feu ou un bloqueur de contenu\n`;
          results += `- Problème de connexion au serveur Lovable\n`;
          results += `- Erreur JavaScript empêchant l'initialisation\n`;
        } else {
          results += `<span class="error">✗ Script Lovable non trouvé dans le DOM</span>\n`;
          results += `<span class="warning">Vérifiez que le script est bien inclus dans votre HTML</span>`;
        }
      }
      
      resultDiv.innerHTML = results;
    }
    
    // Informations sur le navigateur
    function getBrowserInfo() {
      const resultDiv = document.getElementById('browser-results');
      
      const ua = navigator.userAgent;
      const browserInfo = {
        userAgent: ua,
        browser: 'Inconnu',
        engine: 'Inconnu',
        os: 'Inconnu',
        device: 'Inconnu',
        cookiesEnabled: navigator.cookieEnabled,
        localStorage: typeof localStorage !== 'undefined',
        sessionStorage: typeof sessionStorage !== 'undefined',
        online: navigator.onLine
      };
      
      // Détecter le navigateur
      if (ua.indexOf("Chrome") > -1) browserInfo.browser = "Chrome";
      else if (ua.indexOf("Safari") > -1) browserInfo.browser = "Safari";
      else if (ua.indexOf("Firefox") > -1) browserInfo.browser = "Firefox";
      else if (ua.indexOf("MSIE") > -1 || ua.indexOf("Trident") > -1) browserInfo.browser = "Internet Explorer";
      else if (ua.indexOf("Edge") > -1) browserInfo.browser = "Edge";
      else if (ua.indexOf("Opera") > -1) browserInfo.browser = "Opera";
      
      // Détecter l'OS
      if (ua.indexOf("Windows") > -1) browserInfo.os = "Windows";
      else if (ua.indexOf("Mac") > -1) browserInfo.os = "MacOS";
      else if (ua.indexOf("Linux") > -1) browserInfo.os = "Linux";
      else if (ua.indexOf("Android") > -1) browserInfo.os = "Android";
      else if (ua.indexOf("iOS") > -1 || (ua.indexOf("iPhone") > -1) || (ua.indexOf("iPad") > -1)) browserInfo.os = "iOS";
      
      // Détecter le moteur
      if (ua.indexOf("Gecko") > -1) browserInfo.engine = "Gecko";
      else if (ua.indexOf("WebKit") > -1) browserInfo.engine = "WebKit";
      else if (ua.indexOf("Trident") > -1) browserInfo.engine = "Trident";
      else if (ua.indexOf("Presto") > -1) browserInfo.engine = "Presto";
      
      // Détecter le type d'appareil
      if (ua.indexOf("Mobile") > -1 || ua.indexOf("Android") > -1 || ua.indexOf("iPhone") > -1) {
        browserInfo.device = "Mobile";
      } else if (ua.indexOf("iPad") > -1 || ua.indexOf("Tablet") > -1) {
        browserInfo.device = "Tablet";
      } else {
        browserInfo.device = "Desktop";
      }
      
      let results = "";
      for (const [key, value] of Object.entries(browserInfo)) {
        results += `${key}: ${value}\n`;
      }
      
      // Vérifier les fonctionnalités nécessaires
      results += "\n=== Vérification des fonctionnalités ===\n";
      
      if (typeof fetch === 'function') {
        results += `<span class="success">✓ Fetch API supportée</span>\n`;
      } else {
        results += `<span class="error">✗ Fetch API non supportée</span>\n`;
      }
      
      if (typeof Promise === 'function') {
        results += `<span class="success">✓ Promises supportées</span>\n`;
      } else {
        results += `<span class="error">✗ Promises non supportées</span>\n`;
      }
      
      if (browserInfo.localStorage) {
        results += `<span class="success">✓ LocalStorage supporté</span>\n`;
      } else {
        results += `<span class="error">✗ LocalStorage non supporté</span>\n`;
      }
      
      if (browserInfo.cookiesEnabled) {
        results += `<span class="success">✓ Cookies activés</span>\n`;
      } else {
        results += `<span class="error">✗ Cookies désactivés</span>\n`;
      }
      
      if (browserInfo.online) {
        results += `<span class="success">✓ Navigateur connecté à Internet</span>\n`;
      } else {
        results += `<span class="error">✗ Navigateur hors ligne</span>\n`;
      }
      
      resultDiv.innerHTML = results;
    }
    
    // Test de résolution DNS
    function testDns() {
      const resultDiv = document.getElementById('dns-results');
      resultDiv.innerHTML = "Test en cours...";
      
      const domains = [
        'cdn.gpteng.co',
        'lovable.dev',
        'googleapis.com',
        'gstatic.com'
      ];
      
      let results = "";
      let completedTests = 0;
      
      domains.forEach(domain => {
        const img = new Image();
        const startTime = performance.now();
        
        // Timeout pour la requête
        const timeout = setTimeout(() => {
          results += `<span class="error">✗ Timeout pour ${domain}</span>\n`;
          checkCompleted();
        }, 5000);
        
        img.onload = function() {
          clearTimeout(timeout);
          const duration = Math.round(performance.now() - startTime);
          results += `<span class="success">✓ ${domain} résolu en ${duration}ms</span>\n`;
          checkCompleted();
        };
        
        img.onerror = function() {
          clearTimeout(timeout);
          const duration = Math.round(performance.now() - startTime);
          // Une erreur peut signifier que l'image n'existe pas, mais le DNS a peut-être fonctionné
          if (duration < 100) {
            results += `<span class="warning">⚠ ${domain}: DNS résolu mais contenu non accessible (${duration}ms)</span>\n`;
          } else {
            results += `<span class="error">✗ ${domain} non résolu (${duration}ms)</span>\n`;
          }
          checkCompleted();
        };
        
        // Utiliser une image avec un timestamp pour éviter le cache
        img.src = `https://${domain}/favicon.ico?_=${Date.now()}`;
      });
      
      function checkCompleted() {
        completedTests++;
        if (completedTests === domains.length) {
          resultDiv.innerHTML = results;
          
          // Ajouter un résumé
          if (!results.includes("non résolu")) {
            resultDiv.innerHTML += `\n<span class="success">Résolution DNS fonctionnelle pour tous les domaines.</span>`;
          } else {
            resultDiv.innerHTML += `\n<span class="warning">Problèmes de résolution DNS détectés. Vérifiez votre connexion réseau ou vos paramètres DNS.</span>`;
          }
        }
      }
    }
    
    // Exécuter tous les tests
    function runAllTests() {
      const resultDiv = document.getElementById('all-results');
      resultDiv.innerHTML = "Exécution de tous les tests...";
      
      // Lancer tous les tests
      testCdnConnections();
      checkScripts();
      testLovableScript();
      getBrowserInfo();
      testDns();
      
      // Attendre que tous les tests soient terminés
      setTimeout(() => {
        let allResults = "";
        
        // Collecter les résultats
        allResults += "=== RÉSUMÉ DU DIAGNOSTIC ===\n\n";
        
        // CDN
        const cdnResults = document.getElementById('cdn-results').innerHTML;
        if (cdnResults.includes("Tous les CDN sont accessibles")) {
          allResults += "<span class='success'>✓ Connexion aux CDN: OK</span>\n";
        } else {
          allResults += "<span class='error'>✗ Problèmes de connexion aux CDN</span>\n";
        }
        
        // Scripts
        const scriptsResults = document.getElementById('scripts-results').innerHTML;
        if (scriptsResults.includes("Script Lovable trouvé") && scriptsResults.includes("Script principal trouvé")) {
          allResults += "<span class='success'>✓ Scripts: OK</span>\n";
        } else {
          allResults += "<span class='error'>✗ Problèmes avec les scripts</span>\n";
        }
        
        // Lovable
        const lovableResults = document.getElementById('lovable-results').innerHTML;
        if (lovableResults.includes("Console Lovable chargée correctement")) {
          allResults += "<span class='success'>✓ Console Lovable: OK</span>\n";
        } else {
          allResults += "<span class='error'>✗ Problèmes avec la console Lovable</span>\n";
        }
        
        // Navigateur
        const browserResults = document.getElementById('browser-results').innerHTML;
        if (!browserResults.includes("non supportée") && !browserResults.includes("désactivés") && !browserResults.includes("hors ligne")) {
          allResults += "<span class='success'>✓ Navigateur compatible: OK</span>\n";
        } else {
          allResults += "<span class='error'>✗ Problèmes de compatibilité du navigateur</span>\n";
        }
        
        // DNS
        const dnsResults = document.getElementById('dns-results').innerHTML;
        if (dnsResults.includes("Résolution DNS fonctionnelle")) {
          allResults += "<span class='success'>✓ Résolution DNS: OK</span>\n";
        } else {
          allResults += "<span class='error'>✗ Problèmes de résolution DNS</span>\n";
        }
        
        // Recommandations
        allResults += "\n=== RECOMMANDATIONS ===\n\n";
        
        if (allResults.includes("✗")) {
          allResults += "Des problèmes ont été détectés. Essayez les solutions suivantes:\n\n";
          
          if (allResults.includes("Problèmes de connexion aux CDN") || allResults.includes("Problèmes de résolution DNS")) {
            allResults += "1. <b>Problèmes de connexion réseau:</b>\n";
            allResults += "   - Vérifiez votre connexion Internet\n";
            allResults += "   - Désactivez temporairement votre VPN si vous en utilisez un\n";
            allResults += "   - Essayez un autre réseau Wi-Fi\n";
            allResults += "   - Vérifiez votre pare-feu ou contactez votre administrateur réseau\n\n";
          }
          
          if (allResults.includes("Problèmes avec les scripts") || allResults.includes("Problèmes avec la console Lovable")) {
            allResults += "2. <b>Problèmes avec les scripts:</b>\n";
            allResults += "   - Désactivez temporairement vos bloqueurs de publicités (uBlock, AdBlock, etc.)\n";
            allResults += "   - Vérifiez les paramètres de sécurité de votre navigateur\n";
            allResults += "   - Essayez de vider le cache du navigateur (Ctrl+F5 ou Cmd+Shift+R)\n\n";
          }
          
          if (allResults.includes("Problèmes de compatibilité du navigateur")) {
            allResults += "3. <b>Problèmes de compatibilité:</b>\n";
            allResults += "   - Essayez un navigateur différent (Chrome est recommandé)\n";
            allResults += "   - Mettez à jour votre navigateur actuel\n";
            allResults += "   - Désactivez les extensions qui pourraient interférer\n\n";
          }
          
          allResults += "4. <b>Solutions générales:</b>\n";
          allResults += "   - Essayez en mode navigation privée\n";
          allResults += "   - Redémarrez votre navigateur\n";
          allResults += "   - Redémarrez votre ordinateur\n";
          allResults += "   - Contactez le support technique si le problème persiste\n";
        } else {
          allResults += "<span class='success'>✓ Tous les tests sont passés avec succès!</span>\n";
          allResults += "Si vous rencontrez encore des problèmes, essayez de:\n";
          allResults += "   - Actualiser la page (Ctrl+F5 ou Cmd+Shift+R)\n";
          allResults += "   - Redémarrer votre navigateur\n";
          allResults += "   - Contacter le support technique\n";
        }
        
        resultDiv.innerHTML = allResults;
      }, 5000); // Attendre 5 secondes pour que tous les tests aient le temps de s'exécuter
    }
    
    // Exécuter automatiquement tous les tests au chargement
    window.onload = function() {
      setTimeout(runAllTests, 500);
    };
  </script>
</body>
</html>
