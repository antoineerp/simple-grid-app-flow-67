
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'API FormaCert Pro</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .result { background-color: #f5f5f5; padding: 15px; border-radius: 4px; margin-top: 20px; max-height: 500px; overflow: auto; }
        .json { white-space: pre-wrap; font-family: monospace; }
        .success { color: green; border-left: 4px solid green; }
        .error { color: red; border-left: 4px solid red; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border: 1px solid #ddd; border-bottom: none; border-radius: 4px 4px 0 0; }
        .tab.active { background-color: #f0f0f0; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .version { font-size: 12px; color: #888; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: #4CAF50; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .php-check { font-size: 14px; padding: 5px 10px; border-radius: 4px; display: inline-block; margin: 5px 0; }
        .info-box { background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Test d'API FormaCert Pro</h1>
            <div class="version">v2.1.0</div>
        </div>
        
        <div class="info-box">
            Cet outil avancé permet de tester en profondeur la configuration PHP et les API du système FormaCert.
            <div id="phpStatus" class="php-check">Vérification de l'exécution PHP...</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="basic">Tests basiques</div>
            <div class="tab" data-tab="auth">Authentification</div>
            <div class="tab" data-tab="advanced">Tests avancés</div>
            <div class="tab" data-tab="diagnostic">Diagnostic complet</div>
        </div>
        
        <div id="basic" class="tab-content active">
            <div class="card">
                <h2>1. Test de connexion API</h2>
                <div class="form-group">
                    <label for="apiUrl">URL de l'API:</label>
                    <input type="text" id="apiUrl" value="/api/api-debug.php">
                </div>
                <button id="testApi"><span class="spinner hidden"></span>Tester l'API</button>
                <div id="apiResult" class="result"></div>
            </div>
            
            <div class="card">
                <h2>2. Test PHP Info</h2>
                <div class="form-group">
                    <label for="phpInfoUrl">URL PHP Info:</label>
                    <input type="text" id="phpInfoUrl" value="/api/phpinfo.php">
                </div>
                <button id="testPhpInfo"><span class="spinner hidden"></span>Tester PHP Info</button>
                <div id="phpInfoResult" class="result"></div>
            </div>
        </div>
        
        <div id="auth" class="tab-content">
            <div class="card">
                <h2>Test d'authentification</h2>
                <div class="form-group">
                    <label for="loginUrl">URL d'authentification:</label>
                    <select id="loginUrl">
                        <option value="/api/login-test.php">login-test.php</option>
                        <option value="/api/login-fix.php">login-fix.php</option>
                        <option value="/api/test-auth.php">test-auth.php</option>
                        <option value="/api/auth">auth (endpoint)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="username">Nom d'utilisateur:</label>
                    <select id="username">
                        <option value="admin">admin</option>
                        <option value="p71x6d_system">p71x6d_system</option>
                        <option value="antcirier@gmail.com">antcirier@gmail.com</option>
                        <option value="p71x6d_dupont">p71x6d_dupont</option>
                        <option value="p71x6d_martin">p71x6d_martin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="password">Mot de passe:</label>
                    <select id="password">
                        <option value="admin123">admin123</option>
                        <option value="password123">password123</option>
                        <option value="Trottinette43!">Trottinette43!</option>
                        <option value="manager456">manager456</option>
                        <option value="user789">user789</option>
                    </select>
                </div>
                <button id="testLogin"><span class="spinner hidden"></span>Tester l'authentification</button>
                <div id="loginResult" class="result"></div>
            </div>
        </div>
        
        <div id="advanced" class="tab-content">
            <div class="card">
                <h2>Test d'API personnalisé</h2>
                <div class="form-group">
                    <label for="customUrl">URL:</label>
                    <input type="text" id="customUrl" value="/api/php-simple-test.php">
                </div>
                <div class="form-group">
                    <label for="method">Méthode:</label>
                    <select id="method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="OPTIONS">OPTIONS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="headers">En-têtes (JSON):</label>
                    <textarea id="headers" rows="3">{"Content-Type": "application/json", "Accept": "application/json"}</textarea>
                </div>
                <div class="form-group">
                    <label for="body">Corps (JSON):</label>
                    <textarea id="body" rows="5">{"test": true}</textarea>
                </div>
                <button id="testCustom"><span class="spinner hidden"></span>Exécuter le test</button>
                <div id="customResult" class="result"></div>
            </div>
        </div>
        
        <div id="diagnostic" class="tab-content">
            <div class="card">
                <h2>Diagnostic complet du serveur</h2>
                <button id="runFullDiagnostic"><span class="spinner hidden"></span>Exécuter le diagnostic complet</button>
                <div id="diagnosticResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
            
            // Vérifier l'exécution PHP
            async function checkPhpExecution() {
                const phpStatusEl = document.getElementById('phpStatus');
                
                try {
                    phpStatusEl.textContent = "Vérification de l'exécution PHP...";
                    phpStatusEl.className = "php-check";
                    
                    const response = await fetch('/api/php-simple-test.php', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    const contentType = response.headers.get('content-type');
                    const text = await response.text();
                    
                    if (text.startsWith('<?php')) {
                        phpStatusEl.textContent = "⚠️ PHP n'est pas exécuté correctement";
                        phpStatusEl.className = "php-check error";
                    } else if (contentType && contentType.includes('json')) {
                        phpStatusEl.textContent = "✅ PHP s'exécute correctement";
                        phpStatusEl.className = "php-check success";
                    } else {
                        phpStatusEl.textContent = "⚠️ PHP s'exécute mais ne génère pas du JSON valide";
                        phpStatusEl.className = "php-check error";
                    }
                } catch (error) {
                    phpStatusEl.textContent = `❌ Erreur: ${error.message}`;
                    phpStatusEl.className = "php-check error";
                }
            }
            
            checkPhpExecution();
            
            // Format JSON
            function formatJSON(json) {
                try {
                    return JSON.stringify(JSON.parse(json), null, 2);
                } catch (e) {
                    return json;
                }
            }
            
            // Helper pour afficher les résultats
            function showResult(element, status, text, isJson = true) {
                element.className = status >= 200 && status < 300 ? "result success" : "result error";
                let content = `Status: ${status}\n\n`;
                
                if (isJson && text) {
                    try {
                        content += formatJSON(text);
                        element.innerHTML = `<div class="json">${content}</div>`;
                    } catch (e) {
                        element.innerHTML = `<div class="json">${content}${text}</div>`;
                    }
                } else {
                    element.innerHTML = `<div>${content}${text || 'Réponse vide'}</div>`;
                }
            }
            
            // Test API
            document.getElementById('testApi').addEventListener('click', async function() {
                const spinner = this.querySelector('.spinner');
                spinner.classList.remove('hidden');
                
                const apiUrl = document.getElementById('apiUrl').value;
                const resultElement = document.getElementById('apiResult');
                
                try {
                    const response = await fetch(apiUrl, {
                        headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
                    });
                    
                    const text = await response.text();
                    showResult(resultElement, response.status, text);
                } catch (error) {
                    showResult(resultElement, 500, `Erreur: ${error.message}`, false);
                } finally {
                    spinner.classList.add('hidden');
                }
            });
            
            // Test PHP Info
            document.getElementById('testPhpInfo').addEventListener('click', async function() {
                const spinner = this.querySelector('.spinner');
                spinner.classList.remove('hidden');
                
                const phpInfoUrl = document.getElementById('phpInfoUrl').value;
                const resultElement = document.getElementById('phpInfoResult');
                
                try {
                    const response = await fetch(phpInfoUrl, {
                        headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
                    });
                    
                    const text = await response.text();
                    showResult(resultElement, response.status, text);
                } catch (error) {
                    showResult(resultElement, 500, `Erreur: ${error.message}`, false);
                } finally {
                    spinner.classList.add('hidden');
                }
            });
            
            // Test Login
            document.getElementById('testLogin').addEventListener('click', async function() {
                const spinner = this.querySelector('.spinner');
                spinner.classList.remove('hidden');
                
                const loginUrl = document.getElementById('loginUrl').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const resultElement = document.getElementById('loginResult');
                
                try {
                    const response = await fetch(loginUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const text = await response.text();
                    showResult(resultElement, response.status, text);
                } catch (error) {
                    showResult(resultElement, 500, `Erreur: ${error.message}`, false);
                } finally {
                    spinner.classList.add('hidden');
                }
            });
            
            // Test Custom
            document.getElementById('testCustom').addEventListener('click', async function() {
                const spinner = this.querySelector('.spinner');
                spinner.classList.remove('hidden');
                
                const customUrl = document.getElementById('customUrl').value;
                const method = document.getElementById('method').value;
                let headers = {};
                let body = null;
                
                try {
                    headers = JSON.parse(document.getElementById('headers').value);
                    
                    if (method !== 'GET' && method !== 'OPTIONS') {
                        body = document.getElementById('body').value.trim();
                        if (body) {
                            body = JSON.parse(body);
                        }
                    }
                } catch (e) {
                    return showResult(document.getElementById('customResult'), 400, `Erreur de syntaxe JSON: ${e.message}`, false);
                }
                
                const resultElement = document.getElementById('customResult');
                
                try {
                    const options = {
                        method,
                        headers,
                        cache: 'no-cache'
                    };
                    
                    if (body && method !== 'GET' && method !== 'OPTIONS') {
                        options.body = JSON.stringify(body);
                    }
                    
                    const response = await fetch(customUrl, options);
                    const text = await response.text();
                    
                    showResult(resultElement, response.status, text);
                } catch (error) {
                    showResult(resultElement, 500, `Erreur: ${error.message}`, false);
                } finally {
                    spinner.classList.add('hidden');
                }
            });
            
            // Full Diagnostic
            document.getElementById('runFullDiagnostic').addEventListener('click', async function() {
                const spinner = this.querySelector('.spinner');
                spinner.classList.remove('hidden');
                const resultElement = document.getElementById('diagnosticResult');
                
                try {
                    resultElement.innerHTML = "Exécution du diagnostic complet...";
                    
                    // Détails serveur & environnement
                    const apiResponse = await fetch('/api/api-debug.php');
                    const apiData = await apiResponse.text();
                    
                    // Test PHP simple
                    const phpResponse = await fetch('/api/php-simple-test.php');
                    const phpData = await phpResponse.text();
                    
                    // Test .htaccess
                    const htaccessWorks = !phpData.startsWith('<?php');
                    
                    // Résultat formaté
                    let result = `<h3>Résultat du diagnostic</h3>`;
                    result += `<p><strong>Exécution PHP:</strong> ${htaccessWorks ? '✅ Fonctionnelle' : '❌ Non fonctionnelle'}</p>`;
                    
                    result += `<h4>Détails de l'API:</h4>`;
                    result += `<div class="json">${formatJSON(apiData)}</div>`;
                    
                    result += `<h4>PHP Simple Test:</h4>`;
                    result += `<div class="json">${phpData.startsWith('<?php') ? 'PHP code non exécuté:\n' + phpData.substring(0, 500) : formatJSON(phpData)}</div>`;
                    
                    resultElement.innerHTML = result;
                } catch (error) {
                    resultElement.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
                } finally {
                    spinner.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
