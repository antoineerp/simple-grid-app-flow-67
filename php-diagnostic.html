
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic PHP - FormaCert</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow: auto; }
        button { padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,.3); 
                  border-radius: 50%; border-top-color: #4CAF50; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>Diagnostic PHP - FormaCert</h1>
    
    <div class="section">
        <h2>1. Test PHP direct</h2>
        <p>Ce test vérifie si PHP est correctement configuré sur le serveur.</p>
        <button onclick="testPhpDirect()">Tester PHP</button>
        <div id="php-test-result">Résultat: en attente...</div>
    </div>
    
    <div class="section">
        <h2>2. Test des fichiers PHP disponibles</h2>
        <p>Cette section vérifie si les fichiers PHP de diagnostic sont disponibles.</p>
        <button onclick="checkPhpFiles()">Vérifier les fichiers</button>
        <div id="file-check-result">Résultat: en attente...</div>
    </div>
    
    <div class="section">
        <h2>3. Test .htaccess</h2>
        <p>Le fichier .htaccess est crucial pour l'exécution de PHP sur certains serveurs. Voici un exemple de contenu:</p>
        <pre>
AddHandler application/x-httpd-php .php
AddHandler fcgid-script .php
AddHandler php8-fcgi .php

&lt;FilesMatch "\.php$"&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;

Options +ExecCGI
        </pre>
        <button onclick="downloadHtaccess()">Télécharger .htaccess</button>
    </div>
    
    <div class="section">
        <h2>4. Tests avancés</h2>
        <p>Ces tests vérifient d'autres aspects de la configuration PHP:</p>
        <ul>
            <li><a href="api/info.php" target="_blank">phpinfo() - Informations complètes PHP</a></li>
            <li><a href="api/test-php-execution.php" target="_blank">Test d'exécution PHP détaillé</a></li>
            <li><a href="api/deployment-check.php" target="_blank">Vérification du déploiement</a></li>
        </ul>
    </div>

    <div class="section">
        <h2>5. Informations système</h2>
        <div id="system-info">
            <p>URL: <span id="current-url"></span></p>
            <p>Navigateur: <span id="browser-info"></span></p>
            <p>Date et heure: <span id="current-time"></span></p>
        </div>
    </div>
    
    <script>
        // Afficher les informations système
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('browser-info').textContent = navigator.userAgent;
        document.getElementById('current-time').textContent = new Date().toLocaleString();
        
        // Test PHP direct
        async function testPhpDirect() {
            const resultDiv = document.getElementById('php-test-result');
            resultDiv.innerHTML = '<span class="loading"></span> Test en cours...';
            
            try {
                const response = await fetch('api/simple-test.php');
                const text = await response.text();
                
                try {
                    // Essayer de parser comme JSON
                    const json = JSON.parse(text);
                    if (json.status === 'success') {
                        resultDiv.innerHTML = `
                            <p class="success">✅ PHP fonctionne correctement!</p>
                            <p>Version PHP: ${json.php_version}</p>
                            <p>Serveur: ${json.server_software}</p>
                            <p>Horodatage: ${json.timestamp}</p>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <p class="error">❌ PHP renvoie une erreur.</p>
                            <pre>${JSON.stringify(json, null, 2)}</pre>
                        `;
                    }
                } catch (e) {
                    // Si ce n'est pas du JSON, afficher le texte brut
                    if (text.includes('<?php')) {
                        resultDiv.innerHTML = `
                            <p class="error">❌ PHP n'est PAS exécuté. Le code PHP est affiché comme du texte.</p>
                            <pre>${escapeHtml(text)}</pre>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <p class="error">❌ Réponse non-JSON reçue:</p>
                            <pre>${escapeHtml(text)}</pre>
                        `;
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">❌ Erreur lors du test PHP:</p>
                    <pre>${error.message}</pre>
                `;
            }
        }
        
        // Vérifier les fichiers PHP disponibles
        async function checkPhpFiles() {
            const resultDiv = document.getElementById('file-check-result');
            resultDiv.innerHTML = '<span class="loading"></span> Vérification en cours...';
            
            const files = [
                'api/simple-test.php',
                'api/info.php',
                'api/php-test-basic.php',
                'api/test-php-execution.php',
                'api/deployment-check.php'
            ];
            
            let results = '<ul>';
            
            for (const file of files) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    if (response.ok) {
                        results += `<li><span class="success">✅ ${file}</span> - Disponible</li>`;
                    } else {
                        results += `<li><span class="error">❌ ${file}</span> - Non disponible (${response.status})</li>`;
                    }
                } catch (error) {
                    results += `<li><span class="error">❌ ${file}</span> - Erreur: ${error.message}</li>`;
                }
            }
            
            results += '</ul>';
            resultDiv.innerHTML = results;
        }
        
        // Fonction pour échapper les caractères HTML
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Télécharger le fichier .htaccess
        function downloadHtaccess() {
            const htaccessContent = `# Forcer PHP à s'exécuter
AddHandler application/x-httpd-php .php
AddHandler fcgid-script .php
AddHandler php8-fcgi .php

<FilesMatch "\\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>

Options +ExecCGI`;
            
            const blob = new Blob([htaccessContent], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = '.htaccess';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
