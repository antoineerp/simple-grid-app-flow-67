
# Activer le moteur de réécriture
RewriteEngine On
RewriteBase /

# Configuration spécifique pour Infomaniak
Options -MultiViews
Options +FollowSymLinks

# Force execution of PHP scripts - IMPORTANT pour Infomaniak
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>

# Add MIME type and handler for PHP files
AddType application/x-httpd-php .php
AddHandler application/x-httpd-php .php

# Définir les types MIME corrects
AddType application/javascript .js
AddType text/css .css
AddType application/json .json
AddType image/svg+xml .svg

# Permettre l'accès aux assets
<FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map|tsx?)$">
    Order Allow,Deny
    Allow from all
</FilesMatch>

# Règles de réécriture spécifiques pour Infomaniak
# Rediriger les chemins incorrects avec /sites/[domain]/
RewriteCond %{REQUEST_URI} ^/sites/[^/]+/(.*)$
RewriteRule ^sites/[^/]+/(.*)$ /$1 [L,R=301]

# Traitement spécial pour les requêtes API
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/(.*)$ api/$1 [QSA,L]

# Traitement des uploads et ressources statiques
RewriteCond %{REQUEST_URI} ^/lovable-uploads/(.*)$
RewriteCond %{DOCUMENT_ROOT}/lovable-uploads/%1 !-f
RewriteCond %{DOCUMENT_ROOT}/public/lovable-uploads/%1 -f
RewriteRule ^lovable-uploads/(.*)$ /public/lovable-uploads/$1 [L]

# Permettre l'accès direct aux fichiers statiques
RewriteCond %{REQUEST_URI} \.(js|css|png|jpe?g|gif|svg|ico|webp|woff2?|ttf|eot|map|tsx?)$
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# Toutes les autres requêtes sont envoyées à index.html pour React Router
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(?!api/) index.html [L]

# Fichiers index par défaut
DirectoryIndex index.html index.php

# Encodage UTF-8 par défaut
AddDefaultCharset UTF-8

# Configuration de sécurité et cache
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Configuration pour les assets statiques et PHP
    <FilesMatch "\.(js|css|json|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>
