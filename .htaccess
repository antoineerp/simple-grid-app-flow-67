
# Configurations de base
RewriteEngine On
Options +FollowSymLinks

# Définir le point d'entrée principal
DirectoryIndex index.html index.php

# Définir les types MIME corrects
AddType application/javascript .js
AddType application/javascript .mjs
AddType text/css .css

# Forcer explicitement le type MIME pour CSS
<FilesMatch "\.css$">
    ForceType text/css
</FilesMatch>

# Compression Gzip pour améliorer les performances
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
</IfModule>

# En-têtes de mise en cache pour les ressources statiques
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg "access plus 1 month"
  ExpiresByType image/jpeg "access plus 1 month"
  ExpiresByType image/png "access plus 1 month"
  ExpiresByType text/css "access plus 1 week"
  ExpiresByType application/javascript "access plus 1 week"
</IfModule>

<FilesMatch "\.(css|js|jpg|jpeg|png|gif|ico)$">
    Allow from all
</FilesMatch>

# En-têtes de sécurité
Header set X-Content-Type-Options "nosniff"
Header set Content-Security-Policy "frame-ancestors 'self'; default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;"

# Explicitement définir les types MIME dans les en-têtes
<FilesMatch "\.css$">
    Header set Content-Type "text/css; charset=utf-8"
</FilesMatch>
<FilesMatch "\.js$">
    Header set Content-Type "application/javascript; charset=utf-8"
</FilesMatch>
<FilesMatch "\.(html|php)$">
    Header set Content-Type "text/html; charset=utf-8"
    Header set Cache-Control "public, max-age=0, must-revalidate"
</FilesMatch>

# En-têtes de cache corrects
Header set Cache-Control "public, max-age=31536000, immutable"
<FilesMatch "\.(html|php)$">
    Header set Cache-Control "public, max-age=0, must-revalidate"
</FilesMatch>

# Traitement des ressources statiques
RewriteCond %{REQUEST_URI} ^/lovable-uploads/
RewriteRule ^lovable-uploads/(.*)$ public/lovable-uploads/$1 [L]

# Règle spécifique pour rediriger /api vers le dossier api/index.php
RewriteRule ^api$ api/index.php [L]

# Règle pour traiter les requêtes d'API avec des sous-chemins directs
RewriteRule ^api/([^/]+)\.php$ api/$1.php [QSA,L]

# Règle pour traiter les requêtes d'API avec des sous-chemins
RewriteRule ^api/([^/]+)$ api/$1.php [QSA,L]

# Règle pour autres requêtes API
RewriteRule ^api/(.*)$ api/$1 [QSA,L]

# Permettre l'accès direct aux fichiers de diagnostic
RewriteRule ^phpinfo\.php$ - [L]
RewriteRule ^diagnose-infomaniak\.php$ - [L]
RewriteRule ^verify-deploy\.php$ - [L]
RewriteRule ^user-diagnostic\.php$ - [L]
RewriteRule ^php-debug\.php$ - [L]
RewriteRule ^users\.ini$ - [F,L]

# Permettre l'accès direct aux assets dans leur dossier
RewriteCond %{REQUEST_URI} ^/assets/
RewriteRule ^assets/(.*)$ assets/$1 [L]

# Permettre l'accès direct aux fichiers de la racine
RewriteCond %{REQUEST_URI} ^/[^/]+\.(php|html|css|js|jpg|jpeg|png|gif|ico)$
RewriteRule ^(.*)$ $1 [L]

# Rediriger toutes les autres requêtes vers index.html pour React Router
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^(.*)$ index.html [QSA,L]

# Réponses CORS
Header set Access-Control-Allow-Origin "*"
Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header set Access-Control-Allow-Headers "Content-Type, Authorization"

# Gérer les erreurs 404 et 500
ErrorDocument 404 /index.html
ErrorDocument 500 /index.html
