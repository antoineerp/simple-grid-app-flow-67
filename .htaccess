
# Main .htaccess - Forces PHP execution and handles routing for Infomaniak production

# Enable rewrite engine
RewriteEngine On

# Set PHP handler explicitly for Infomaniak
AddHandler application/x-httpd-php .php
AddType application/x-httpd-php .php

# Force PHP for all .php files
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>

# Force PHP interpreter for all PHP files
<FilesMatch "\.php$">
    <IfModule mod_mime.c>
        ForceType application/x-httpd-php
    </IfModule>
</FilesMatch>

# Enable PHP engine explicitly
<IfModule mod_php.c>
    php_flag engine on
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization"
</IfModule>

# Set correct MIME types - Critical for JavaScript modules
AddType application/javascript .js
AddType application/javascript .mjs
AddType application/javascript .es.js
AddType text/css .css
AddType application/json .json
AddType image/svg+xml .svg

# Force JavaScript MIME types explicitly - Important for modules
<FilesMatch "\.(js|mjs|es.js)$">
    Header set Content-Type "application/javascript"
</FilesMatch>

# API requests should not be redirected
RewriteRule ^api/ - [L]

# PHP files should be processed directly
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule \.(php)$ - [L]

# For service workers
<Files "sync-service-worker.js">
    Header set Content-Type "application/javascript"
    Header set Service-Worker-Allowed "/"
</Files>

# Redirect all other requests to index.html for client-side routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.html [QSA,L]
