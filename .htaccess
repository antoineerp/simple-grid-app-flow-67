
RewriteEngine On
Options -MultiViews
Options +FollowSymLinks
Options +ExecCGI
DirectoryIndex index.html index.php

# Force PHP interpretation
AddHandler application/x-httpd-php .php

# Définir correctement les types MIME pour les extensions de fichiers
AddType application/javascript .js
AddType application/javascript .mjs
AddType application/javascript .jsx
AddType text/javascript .tsx
AddType text/javascript .ts
AddType text/css .css
AddType application/json .json
AddType image/svg+xml .svg

# Bloquer l'accès direct aux fichiers sensibles
<FilesMatch "^\.env">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "^\.user.ini">
    Order allow,deny
    Deny from all
</FilesMatch>

# Autoriser CORS pour les ressources statiques
<FilesMatch "\.(js|mjs|jsx|tsx|ts|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$">
    Header set Access-Control-Allow-Origin "*"
    Header set X-Content-Type-Options "nosniff"
    Header set Cache-Control "no-cache, no-store, must-revalidate"
</FilesMatch>

# Configuration pour forcer l'interprétation PHP
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
    # Force the content type to be application/json for API responses
    Header set Content-Type "application/json; charset=UTF-8"
</FilesMatch>

# Ajouter un User-Agent par défaut pour les requêtes sans User-Agent
SetEnvIf User-Agent "^$" force-default-ua=1
RequestHeader set User-Agent "Mozilla/5.0 (compatible; FormaCertBot)" env=force-default-ua

# Règles spécifiques pour Lovable
RewriteRule ^lovable-uploads/(.*)$ public/lovable-uploads/$1 [L]

# Règle spécifique pour le favicon
RewriteRule ^favicon\.ico$ /lovable-uploads/formacert-logo.png [L]

# Règles pour les fichiers API
RewriteRule ^assets-check\.php$ api/assets-check.php [L]
RewriteRule ^verify-deploy\.php$ verify-deploy.php [L]
RewriteRule ^diagnose-assets\.php$ api/diagnose-assets.php [L]

# Règles pour l'API
RewriteRule ^api$ api/ [R=301,L]
RewriteRule ^api/(.*)$ api/$1 [QSA,L]

# Règles importantes pour les assets
RewriteRule ^assets/(.*)$ dist/assets/$1 [L]
RewriteRule ^dist/(.*)$ dist/$1 [L]
RewriteRule ^src/(.*)$ src/$1 [L]

# Configuration spécifique pour les fichiers JavaScript/JSX/TypeScript/TSX
<FilesMatch "\.js$|\.mjs$|\.jsx$|\.tsx$|\.ts$">
    Header set Content-Type "application/javascript; charset=UTF-8"
    Header set X-Content-Type-Options "nosniff"
    Header set Cache-Control "no-cache, no-store, must-revalidate"
</FilesMatch>

# Règles pour le script Lovable
RewriteCond %{HTTP_REFERER} cdn\.gpteng\.co [NC]
RewriteRule .* - [L]
RewriteRule \.gpteng\.co/gptengineer\.js - [L]

# Autoriser l'accès aux CDN externes
RewriteCond %{REQUEST_URI} ^https?://([^.]+\.)?googleapis\.com [NC,OR]
RewriteCond %{REQUEST_URI} ^https?://([^.]+\.)?gstatic\.com [NC,OR]
RewriteCond %{REQUEST_URI} ^https?://([^.]+\.)?lovable\.dev [NC,OR]
RewriteCond %{REQUEST_URI} ^https?://([^.]+\.)?gpteng\.co [NC]
RewriteRule .* - [L]

# Accès direct aux fichiers statiques
RewriteCond %{REQUEST_URI} \.(js|mjs|jsx|tsx|ts|css|png|jpe?g|gif|svg|ico|webp|woff2?|ttf|eot|map)$
RewriteRule ^ - [L]

# Route de secours pour SPA - TRÈS IMPORTANT
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.html [QSA,L]

# Configuration des en-têtes HTTP
<IfModule mod_headers.c>
    # Désactiver la mise en cache pour les fichiers de développement
    <FilesMatch "\.(html|js|mjs|jsx|tsx|ts|css|json)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
    
    # Autoriser CORS pour toutes les ressources
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept"
</IfModule>
