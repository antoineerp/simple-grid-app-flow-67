
# Configurations de base
RewriteEngine On
Options +FollowSymLinks

# Définir le point d'entrée principal
DirectoryIndex index.html index.php

# Définir les types MIME corrects
AddType application/javascript .js
AddType application/javascript .mjs
AddType text/css .css

# Forcer explicitement le type MIME pour CSS
<FilesMatch "\.css$">
    ForceType text/css
    Header set Content-Type "text/css; charset=utf-8"
</FilesMatch>

<FilesMatch "\.js$">
    ForceType application/javascript
    Header set Content-Type "application/javascript; charset=utf-8"
</FilesMatch>

# Compression Gzip pour améliorer les performances
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
</IfModule>

# En-têtes de mise en cache pour les ressources statiques
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg "access plus 1 month"
  ExpiresByType image/jpeg "access plus 1 month"
  ExpiresByType image/png "access plus 1 month"
  ExpiresByType image/svg+xml "access plus 1 month"
  ExpiresByType text/css "access plus 1 week"
  ExpiresByType application/javascript "access plus 1 week"
  ExpiresByType application/json "access plus 1 day"
</IfModule>

# Meilleur contrôle du cache
<FilesMatch "\.(css|js|jpg|jpeg|png|gif|ico|svg)$">
    Header set Cache-Control "public, max-age=31536000"
</FilesMatch>

<FilesMatch "\.(html|php)$">
    Header set Cache-Control "public, max-age=86400"
</FilesMatch>

# En-têtes de sécurité
Header set X-Content-Type-Options "nosniff"
Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; object-src 'none'; media-src 'self'; frame-src 'self'; frame-ancestors 'self'; form-action 'self';"

# Explicitement définir les types MIME dans les en-têtes
<FilesMatch "\.css$">
    Header set Content-Type "text/css; charset=utf-8"
</FilesMatch>
<FilesMatch "\.js$">
    Header set Content-Type "application/javascript; charset=utf-8"
</FilesMatch>
<FilesMatch "\.(html|php)$">
    Header set Content-Type "text/html; charset=utf-8"
</FilesMatch>

# Permettre l'accès direct aux scripts de diagnostic
<FilesMatch "^(phpinfo|fix-htaccess|check-infomaniak|infomaniak-fix|deploy-on-infomaniak)\.php$">
    # Aucune réécriture pour ces fichiers
</FilesMatch>

# Traitement des ressources statiques
RewriteCond %{REQUEST_URI} ^/lovable-uploads/
RewriteRule ^lovable-uploads/(.*)$ public/lovable-uploads/$1 [L]

# Règle spécifique pour rediriger /api vers le dossier api/index.php
RewriteRule ^api$ api/index.php [L]

# Règle pour traiter les requêtes d'API avec des sous-chemins directs
RewriteRule ^api/([^/]+)\.php$ api/$1.php [QSA,L]

# Règle pour traiter les requêtes d'API avec des sous-chemins
RewriteRule ^api/([^/]+)$ api/$1.php [QSA,L]

# Règle pour autres requêtes API
RewriteRule ^api/(.*)$ api/$1 [QSA,L]

# Permettre l'accès direct aux assets dans leur dossier
RewriteCond %{REQUEST_URI} ^/assets/
RewriteRule ^assets/(.*)$ assets/$1 [L]

# Permettre l'accès direct aux fichiers de la racine
RewriteCond %{REQUEST_URI} ^/[^/]+\.(php|html|css|js|jpg|jpeg|png|gif|ico)$
RewriteRule ^(.*)$ $1 [L]

# Rediriger toutes les autres requêtes vers index.html pour React Router
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^(.*)$ index.html [QSA,L]

# Réponses CORS
Header set Access-Control-Allow-Origin "*"
Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header set Access-Control-Allow-Headers "Content-Type, Authorization"

# Gérer les erreurs 404 et 500
ErrorDocument 404 /index.html
ErrorDocument 500 /index.html
